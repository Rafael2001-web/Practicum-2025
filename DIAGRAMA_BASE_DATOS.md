# ๐ **DIAGRAMA DE BASE DE DATOS - Sistema de Gestiรณn de Planificaciรณn Institucional**

## ๐๏ธ **ARQUITECTURA DE LA BASE DE DATOS**

Este diagrama muestra la estructura completa de la base de datos del Sistema de Gestiรณn de Planificaciรณn Institucional con todas sus tablas, campos y relaciones.

---

## ๐๏ธ **TABLAS PRINCIPALES**

### ๐ฅ **TABLA: users**
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 users                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ id (PK)              BIGINT         โ
โ    name                  VARCHAR(255)   โ
โ    email                 VARCHAR(255)   โ [UNIQUE]
โ    email_verified_at     TIMESTAMP      โ [NULL]
โ    password              VARCHAR(255)   โ
โ    remember_token        VARCHAR(100)   โ [NULL]
โ    created_at            TIMESTAMP      โ
โ    updated_at            TIMESTAMP      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐๏ธ **TABLA: entidad**
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                entidad                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ idEntidad (PK)        BIGINT         โ
โ    codigo                INTEGER        โ [UNIQUE]
โ    subSector             VARCHAR(255)   โ
โ    nivelGobierno         VARCHAR(255)   โ
โ    estado                VARCHAR(255)   โ
โ    fechaCreacion         DATE           โ
โ    fechaActualizacion    DATE           โ [NULL]
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐ **TABLA: programa**
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               programa                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ idPrograma (PK)       BIGINT         โ
โ ๐ idEntidad (FK)        BIGINT         โ โ entidad.idEntidad
โ    nombre                VARCHAR(255)   โ
โ    descripcion           VARCHAR(255)   โ [NULL]
โ    created_at            TIMESTAMP      โ
โ    updated_at            TIMESTAMP      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐ **TABLA: proyectos**
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              proyectos                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ id (PK)               BIGINT         โ
โ    codigo                VARCHAR(255)   โ [UNIQUE]
โ    nombre                VARCHAR(255)   โ
โ    descripcion           TEXT           โ
โ    sector                VARCHAR(255)   โ
โ    fecha_inicio          DATE           โ
โ    fecha_fin             DATE           โ
โ    presupuesto          DECIMAL(12,2)   โ
โ    estado               VARCHAR(255)    โ [DEFAULT: 'borrador']
โ ๐ user_id (FK)         BIGINT          โ โ users.id
โ    created_at           TIMESTAMP       โ
โ    updated_at           TIMESTAMP       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐ **TABLA: plan**
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 plan                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ idPlan (PK)          BIGINT          โ
โ    codigo               VARCHAR(255)    โ [UNIQUE]
โ    nombre               VARCHAR(255)    โ
โ    entidad              TEXT            โ
โ    presupuesto         DECIMAL(12,2)    โ
โ    fecha_inicio        DATE             โ
โ    fecha_fin           DATE             โ
โ    estado              VARCHAR(255)     โ [DEFAULT: 'estado']
โ    created_at          TIMESTAMP        โ
โ    updated_at          TIMESTAMP        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐ **TABLA: ods** (Objetivos de Desarrollo Sostenible)
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  ods                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ idOds (PK)           BIGINT          โ
โ    odsnum               INTEGER         โ
โ    nombre               VARCHAR(255)    โ
โ    descripcion          TEXT            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐ฏ **TABLA: objEstrategicos** (Objetivos Estratรฉgicos)
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            objEstrategicos              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ idobjEstrategico (PK) BIGINT         โ
โ    fechaRegistro         DATE           โ
โ    descripcion           TEXT           โ
โ    estado                VARCHAR(255)   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐ต๐ช **TABLA: pnd** (Plan Nacional de Desarrollo)
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 pnd                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ idPnd (PK)           BIGINT          โ
โ    eje                  VARCHAR(255)    โ
โ    objetivoN            VARCHAR(255)    โ
โ    descripcion          TEXT            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐ **TABLA: unidad**
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               unidad                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ idUnidad (PK)        BIGINT          โ
โ    macrosector          VARCHAR(255)    โ
โ    sector               VARCHAR(255)    โ
โ    estado               VARCHAR(255)    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ก๏ธ **TABLAS DEL SISTEMA DE PERMISOS Y ROLES (Spatie)**

### ๐ค **TABLA: roles**
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                roles                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ id (PK)              BIGINT          โ
โ    name                 VARCHAR(255)    โ
โ    guard_name           VARCHAR(255)    โ
โ    created_at           TIMESTAMP       โ
โ    updated_at           TIMESTAMP       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐ **TABLA: permissions**
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              permissions                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ id (PK)              BIGINT          โ
โ    name                 VARCHAR(255)    โ
โ    guard_name           VARCHAR(255)    โ
โ    created_at           TIMESTAMP       โ
โ    updated_at           TIMESTAMP       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐ **TABLA: model_has_roles** (Tabla Pivot)
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ             model_has_roles             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ role_id (FK)         BIGINT          โ โ roles.id
โ    model_type           VARCHAR(255)    โ
โ    model_id             BIGINT          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐ **TABLA: model_has_permissions** (Tabla Pivot)
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          model_has_permissions          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ permission_id (FK)   BIGINT          โ โ permissions.id
โ    model_type           VARCHAR(255)    โ
โ    model_id             BIGINT          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐ **TABLA: role_has_permissions** (Tabla Pivot)
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           role_has_permissions          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ role_id (FK)         BIGINT          โ โ roles.id
โ ๐ permission_id (FK)   BIGINT          โ โ permissions.id
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ **TABLAS AUXILIARES DEL SISTEMA**

### ๐ **TABLA: password_reset_tokens**
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          password_reset_tokens          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ    email                VARCHAR(255)    โ [PK]
โ    token                VARCHAR(255)    โ
โ    created_at           TIMESTAMP       โ [NULL]
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ๐ **TABLA: personal_access_tokens**
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ          personal_access_tokens         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ id (PK)              BIGINT          โ
โ    tokenable_type       VARCHAR(255)    โ
โ    tokenable_id         BIGINT          โ
โ    name                 VARCHAR(255)    โ
โ    token                VARCHAR(64)     โ [UNIQUE]
โ    abilities            TEXT            โ [NULL]
โ    last_used_at         TIMESTAMP       โ [NULL]
โ    expires_at           TIMESTAMP       โ [NULL]
โ    created_at           TIMESTAMP       โ
โ    updated_at           TIMESTAMP       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### โ **TABLA: failed_jobs**
```sql
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              failed_jobs                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ id (PK)              BIGINT          โ
โ    uuid                 VARCHAR(255)    โ [UNIQUE]
โ    connection           TEXT            โ
โ    queue                TEXT            โ
โ    payload              LONGTEXT        โ
โ    exception            LONGTEXT        โ
โ    failed_at            TIMESTAMP       โ [DEFAULT: now()]
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ **DIAGRAMA DE RELACIONES MEJORADO**

```mermaid
erDiagram
    users {
        bigint id PK
        varchar name
        varchar email UK
        timestamp email_verified_at
        varchar password
        varchar remember_token
        timestamp created_at
        timestamp updated_at
    }
    
    unidad {
        bigint idUnidad PK
        varchar macrosector
        varchar sector
        varchar estado
    }
    
    entidad {
        bigint idEntidad PK
        integer codigo UK
        varchar subSector
        varchar nivelGobierno
        varchar estado
        date fechaCreacion
        date fechaActualizacion
        bigint idUnidad FK
    }
    
    plan {
        bigint idPlan PK
        varchar codigo UK
        varchar nombre
        bigint idEntidad FK
        decimal presupuesto
        date fecha_inicio
        date fecha_fin
        varchar estado
        timestamp created_at
        timestamp updated_at
    }
    
    programa {
        bigint idPrograma PK
        bigint idEntidad FK
        bigint idPlan FK
        varchar nombre
        varchar descripcion
        timestamp created_at
        timestamp updated_at
    }
    
    proyectos {
        bigint id PK
        varchar codigo UK
        varchar nombre
        text descripcion
        varchar sector
        date fecha_inicio
        date fecha_fin
        decimal presupuesto
        varchar estado
        bigint user_id FK
        bigint idPrograma FK
        timestamp created_at
        timestamp updated_at
    }
    
    ods {
        bigint idOds PK
        integer odsnum
        varchar nombre
        text descripcion
    }
    
    objEstrategicos {
        bigint idobjEstrategico PK
        date fechaRegistro
        text descripcion
        varchar estado
    }
    
    pnd {
        bigint idPnd PK
        varchar eje
        varchar objetivoN
        text descripcion
    }
    
    unidad {
        bigint idUnidad PK
        varchar macrosector
        varchar sector
        varchar estado
    }
    
    roles {
        bigint id PK
        varchar name
        varchar guard_name
        timestamp created_at
        timestamp updated_at
    }
    
    permissions {
        bigint id PK
        varchar name
        varchar guard_name
        timestamp created_at
        timestamp updated_at
    }
    
    model_has_roles {
        bigint role_id FK
        varchar model_type
        bigint model_id
    }
    
    model_has_permissions {
        bigint permission_id FK
        varchar model_type
        bigint model_id
    }
    
    role_has_permissions {
        bigint role_id FK
        bigint permission_id FK
    }

    plan_ods {
        bigint id PK
        bigint idPlan FK
        bigint idOds FK
        decimal porcentaje_contribucion
        timestamp created_at
        timestamp updated_at
    }
    
    plan_objetivos_estrategicos {
        bigint id PK
        bigint idPlan FK
        bigint idobjEstrategico FK
        enum prioridad
        timestamp created_at
        timestamp updated_at
    }
    
    plan_pnd {
        bigint id PK
        bigint idPlan FK
        bigint idPnd FK
        enum nivel_alineacion
        timestamp created_at
        timestamp updated_at
    }
    
    proyecto_ods {
        bigint id PK
        bigint proyecto_id FK
        bigint idOds FK
        text impacto_esperado
        text indicadores
        timestamp created_at
        timestamp updated_at
    }

    %% JERARQUรA ORGANIZACIONAL
    unidad ||--o{ entidad : "Una unidad tiene muchas entidades"
    entidad ||--o{ plan : "Una entidad tiene muchos planes"
    entidad ||--o{ programa : "Una entidad tiene muchos programas"
    plan ||--o{ programa : "Un plan tiene muchos programas"
    programa ||--o{ proyectos : "Un programa tiene muchos proyectos"
    users ||--o{ proyectos : "Un usuario puede tener muchos proyectos"
    
    %% ALINEACIรN ESTRATรGICA (RELACIONES N:M)
    plan ||--o{ plan_ods : "Un plan se alinea con varios ODS"
    ods ||--o{ plan_ods : "Un ODS puede estar en varios planes"
    plan ||--o{ plan_objetivos_estrategicos : "Un plan tiene varios objetivos estratรฉgicos"
    objEstrategicos ||--o{ plan_objetivos_estrategicos : "Un objetivo puede estar en varios planes"
    plan ||--o{ plan_pnd : "Un plan se alinea con varios elementos del PND"
    pnd ||--o{ plan_pnd : "Un elemento PND puede estar en varios planes"
    proyectos ||--o{ proyecto_ods : "Un proyecto contribuye a varios ODS"
    ods ||--o{ proyecto_ods : "Un ODS puede recibir contribuciรณn de varios proyectos"
    
    %% RELACIONES DEL SISTEMA DE PERMISOS
    roles ||--o{ model_has_roles : "Un rol puede ser asignado a muchos modelos"
    permissions ||--o{ model_has_permissions : "Un permiso puede ser asignado a muchos modelos"
    roles ||--o{ role_has_permissions : "Un rol puede tener muchos permisos"
    permissions ||--o{ role_has_permissions : "Un permiso puede pertenecer a muchos roles"
    
    %% RELACIONES POLIMรRFICAS
    users ||--o{ model_has_roles : "Los usuarios pueden tener roles"
    users ||--o{ model_has_permissions : "Los usuarios pueden tener permisos directos"
```

---

## ๐ **RESUMEN DE RELACIONES IDENTIFICADAS**

### ๐ **RELACIONES MEJORADAS EN MODELOS**

#### ๐ **JERARQUรA ORGANIZACIONAL**
| **Modelo** | **Relaciรณn** | **Tipo** | **Descripciรณn** |
|------------|--------------|----------|-----------------|
| **Unidad** | `entidades()` | HasMany | Una unidad tiene muchas entidades |
| **Entidad** | `unidad()` | BelongsTo | Una entidad pertenece a una unidad |
| **Entidad** | `planes()` | HasMany | Una entidad tiene muchos planes |
| **Entidad** | `programas()` | HasMany | Una entidad tiene muchos programas |
| **Plan** | `entidad()` | BelongsTo | Un plan pertenece a una entidad |
| **Plan** | `programas()` | HasMany | Un plan tiene muchos programas |
| **Programa** | `entidad()` | BelongsTo | Un programa pertenece a una entidad |
| **Programa** | `plan()` | BelongsTo | Un programa pertenece a un plan |
| **Programa** | `proyectos()` | HasMany | Un programa tiene muchos proyectos |
| **Proyecto** | `user()` | BelongsTo | Un proyecto pertenece a un usuario |
| **Proyecto** | `programa()` | BelongsTo | Un proyecto pertenece a un programa |
| **User** | `proyectos()` | HasMany | Un usuario tiene muchos proyectos |

#### ๐ฏ **ALINEACIรN ESTRATรGICA**
| **Modelo** | **Relaciรณn** | **Tipo** | **Descripciรณn** |
|------------|--------------|----------|-----------------|
| **Plan** | `ods()` | BelongsToMany | Un plan se alinea con varios ODS |
| **Plan** | `objetivosEstrategicos()` | BelongsToMany | Un plan tiene varios objetivos estratรฉgicos |
| **Plan** | `pnd()` | BelongsToMany | Un plan se alinea con varios elementos del PND |
| **Proyecto** | `ods()` | BelongsToMany | Un proyecto contribuye a varios ODS |

### ๐ **RELACIONES DEL SISTEMA DE PERMISOS (SPATIE)**

| **Relaciรณn** | **Tipo** | **Descripciรณn** |
|--------------|----------|-----------------|
| **User โ Role** | Many-to-Many | Los usuarios pueden tener mรบltiples roles |
| **User โ Permission** | Many-to-Many | Los usuarios pueden tener permisos directos |
| **Role โ Permission** | Many-to-Many | Los roles pueden tener mรบltiples permisos |

### ๏ฟฝ **TABLAS PIVOT PARA ALINEACIรN ESTRATรGICA**

| **Tabla Pivot** | **Relaciona** | **Campos Adicionales** | **Propรณsito** |
|-----------------|---------------|------------------------|---------------|
| **plan_ods** | Plan โ ODS | `porcentaje_contribucion` | Medir contribuciรณn a objetivos globales |
| **plan_objetivos_estrategicos** | Plan โ Obj.Estratรฉgicos | `prioridad` | Definir prioridades institucionales |
| **plan_pnd** | Plan โ PND | `nivel_alineacion` | Asegurar cumplimiento normativo nacional |
| **proyecto_ods** | Proyecto โ ODS | `impacto_esperado`, `indicadores` | Seguimiento detallado de impacto |

### ๐ **TABLAS DE CATรLOGO (MAESTRAS)**

- **ODS**: Catรกlogo oficial de 17 Objetivos de Desarrollo Sostenible
- **PND**: Estructura del Plan Nacional de Desarrollo por ejes
- **objEstrategicos**: Objetivos estratรฉgicos institucionales definidos

---

## โ **NUEVA ARQUITECTURA IMPLEMENTADA**

### ๐๏ธ **JERARQUรA ORGANIZACIONAL COMPLETA**

```
UNIDAD (Macrosector/Sector)
    โ 1:N
ENTIDAD (Organismo especรญfico)
    โ 1:N
PLAN (Planificaciรณn institucional) โโ N:M โโ ODS, PND, Obj.Estratรฉgicos
    โ 1:N
PROGRAMA (Lรญneas de acciรณn)
    โ 1:N
PROYECTO (Iniciativas especรญficas) โโ N:M โโ ODS
```

### ๐ฏ **BENEFICIOS DE LA NUEVA ESTRUCTURA**

1. **โ Integridad Referencial**: Todas las entidades estรกn relacionadas correctamente
2. **โ Trazabilidad Completa**: Seguimiento desde planificaciรณn hasta ejecuciรณn
3. **โ Alineaciรณn Estratรฉgica**: Vรญnculos con marcos nacionales e internacionales
4. **โ Flexibilidad**: Relaciones N:M para casos complejos de alineaciรณn
5. **โ Escalabilidad**: Estructura preparada para crecimiento futuro

### ๏ฟฝ **IMPLEMENTACIรN RECOMENDADA**

Para implementar estas mejoras, consulta el archivo: **`PROPUESTA_MEJORAS_BASE_DATOS.md`**

El archivo contiene:
- ๐ **Migraciones detalladas** para cada cambio
- ๐ง **Modelos Eloquent actualizados** con todas las relaciones
- ๐ **Scripts SQL** para las tablas pivot
- ๐ฏ **Plan de implementaciรณn** paso a paso

---

**๐ ESTADO ACTUAL: BASE DE DATOS CON ESTRUCTURA SรLIDA Y SISTEMA DE PERMISOS IMPLEMENTADO**

*El diagrama muestra una base de datos bien estructurada con separaciรณn clara de responsabilidades, sistema completo de permisos y roles, y potencial para implementar relaciones adicionales que fortalezcan la integridad referencial del sistema.*