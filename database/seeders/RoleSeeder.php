<?php

namespace Database\Seeders;

use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;
use Spatie\Permission\Models\Role;
use Spatie\Permission\Models\Permission;
use App\Models\User;

class RoleSeeder extends Seeder
{
    /**
     * Run the database seeds.
     * Basado en el documento CASOS_DE_USO.md - Sistema de roles espec√≠ficos por CRUD
     */
    public function run(): void
    {
        // ==================================================================================
        // CREAR LOS 10 ROLES ESPEC√çFICOS DEL SISTEMA SIPEIP 2.0
        // ==================================================================================
        
        $adminRole = Role::firstOrCreate(['name' => 'Administrador del Sistema']);
        $gestorEntidadesRole = Role::firstOrCreate(['name' => 'Gestor de Entidades']);
        $coordinadorUnidadesRole = Role::firstOrCreate(['name' => 'Coordinador de Unidades']);
        $especialistaOdsRole = Role::firstOrCreate(['name' => 'Especialista en ODS']);
        $planificadorEstrategicoRole = Role::firstOrCreate(['name' => 'Planificador Estrat√©gico']);
        $analistaPndRole = Role::firstOrCreate(['name' => 'Analista de PND']);
        $gestorPlanesRole = Role::firstOrCreate(['name' => 'Gestor de Planes']);
        $coordinadorProgramasRole = Role::firstOrCreate(['name' => 'Coordinador de Programas']);
        $analistaProyectosRole = Role::firstOrCreate(['name' => 'Analista de Proyectos']);
        $supervisorGeneralRole = Role::firstOrCreate(['name' => 'Supervisor General']);

        // ==================================================================================
        // DEFINIR TODOS LOS PERMISOS DEL SISTEMA
        // ==================================================================================
        
        $permissions = [
            // ===== DASHBOARD =====
            'view dashboard',
            
            // ===== USUARIOS (Administrador del Sistema) =====
            'manage usuarios',
            'view usuarios',
            'create usuarios',
            'edit usuarios',
            'delete usuarios',
            
            // ===== ENTIDADES (Gestor de Entidades) =====
            'manage entidades',
            'view entidades',
            'create entidades',
            'edit entidades',
            'delete entidades',
            
            // ===== UNIDADES (Coordinador de Unidades) =====
            'manage unidades',
            'view unidades',
            'create unidades',
            'edit unidades',
            'delete unidades',
            
            // ===== ODS (Especialista en ODS) =====
            'manage ods',
            'view ods',
            'create ods',
            'edit ods',
            'delete ods',
            
            // ===== OBJETIVOS ESTRAT√âGICOS (Planificador Estrat√©gico) =====
            'manage objetivos_estrategicos',
            'view objetivos_estrategicos',
            'create objetivos_estrategicos',
            'edit objetivos_estrategicos',
            'delete objetivos_estrategicos',
            
            // ===== PND (Analista de PND) =====
            'manage pnd',
            'view pnd',
            'create pnd',
            'edit pnd',
            'delete pnd',
            
            // ===== PLANES (Gestor de Planes) =====
            'manage planes',
            'view planes',
            'create planes',
            'edit planes',
            'delete planes',
            
            // ===== PROGRAMAS (Coordinador de Programas) =====
            'manage programas',
            'view programas',
            'create programas',
            'edit programas',
            'delete programas',
            
            // ===== PROYECTOS (Analista de Proyectos) =====
            'manage proyectos',
            'view proyectos',
            'create proyectos',
            'edit proyectos',
            'delete proyectos',
            
            // ===== REPORTES Y SUPERVISI√ìN =====
            'view reports',
            'generate reports',
            'export reports',
            'view all_modules', // Para supervisor general
        ];

        // Crear todos los permisos
        foreach ($permissions as $permission) {
            Permission::firstOrCreate(['name' => $permission]);
        }

        // ==================================================================================
        // ASIGNAR PERMISOS POR ROL - SEG√öN CASOS DE USO
        // ==================================================================================

        // üëë ADMINISTRADOR DEL SISTEMA
        // ‚úÖ CRUD COMPLETO: Usuarios
        // üëÄ SOLO LECTURA: Todos los dem√°s CRUDs (supervisi√≥n)
        $adminRole->givePermissionTo([
            'view dashboard',
            // Gesti√≥n completa de usuarios
            'manage usuarios',
            'view usuarios',
            'create usuarios',
            'edit usuarios',
            'delete usuarios',
            // Solo lectura de todos los dem√°s m√≥dulos (supervisi√≥n)
            'view entidades',
            'view unidades',
            'view ods',
            'view objetivos_estrategicos',
            'view pnd',
            'view planes',
            'view programas',
            'view proyectos',
        ]);

        // üè¢ GESTOR DE ENTIDADES
        // ‚úÖ CRUD COMPLETO: Entidades
        // üëÄ SOLO LECTURA: Programas (para verificar relaciones)
        $gestorEntidadesRole->givePermissionTo([
            'view dashboard',
            'manage entidades',
            'view entidades',
            'create entidades',
            'edit entidades',
            'delete entidades',
            'view programas', // Para verificar relaciones
        ]);

        // üèóÔ∏è COORDINADOR DE UNIDADES
        // ‚úÖ CRUD COMPLETO: Unidades
        // üëÄ SOLO LECTURA: Usuarios, Entidades (para contexto organizacional)
        $coordinadorUnidadesRole->givePermissionTo([
            'view dashboard',
            'manage unidades',
            'view unidades',
            'create unidades',
            'edit unidades',
            'delete unidades',
            'view usuarios', // Para contexto organizacional
            'view entidades', // Para contexto organizacional
        ]);

        // üéØ ESPECIALISTA EN ODS
        // ‚úÖ CRUD COMPLETO: ODS
        // üëÄ SOLO LECTURA: Objetivos Estrat√©gicos, Planes (para alineaci√≥n)
        $especialistaOdsRole->givePermissionTo([
            'view dashboard',
            'manage ods',
            'view ods',
            'create ods',
            'edit ods',
            'delete ods',
            'view objetivos_estrategicos', // Para alineaci√≥n
            'view planes', // Para alineaci√≥n
        ]);

        // üéØ PLANIFICADOR ESTRAT√âGICO
        // ‚úÖ CRUD COMPLETO: Objetivos Estrat√©gicos
        // üëÄ SOLO LECTURA: ODS, PND, Planes (para alineaci√≥n estrat√©gica)
        $planificadorEstrategicoRole->givePermissionTo([
            'view dashboard',
            'manage objetivos_estrategicos',
            'view objetivos_estrategicos',
            'create objetivos_estrategicos',
            'edit objetivos_estrategicos',
            'delete objetivos_estrategicos',
            'view ods', // Para alineaci√≥n
            'view pnd', // Para alineaci√≥n
            'view planes', // Para alineaci√≥n
        ]);

        // üáµüá™ ANALISTA DE PND
        // ‚úÖ CRUD COMPLETO: PND
        // üëÄ SOLO LECTURA: Objetivos Estrat√©gicos, Planes (para coherencia nacional)
        $analistaPndRole->givePermissionTo([
            'view dashboard',
            'manage pnd',
            'view pnd',
            'create pnd',
            'edit pnd',
            'delete pnd',
            'view objetivos_estrategicos', // Para coherencia
            'view planes', // Para coherencia
        ]);

        // üìã GESTOR DE PLANES
        // ‚úÖ CRUD COMPLETO: Planes
        // üëÄ SOLO LECTURA: Objetivos Estrat√©gicos, ODS, PND, Programas (para alineaci√≥n)
        $gestorPlanesRole->givePermissionTo([
            'view dashboard',
            'manage planes',
            'view planes',
            'create planes',
            'edit planes',
            'delete planes',
            'view objetivos_estrategicos', // Para alineaci√≥n
            'view ods', // Para alineaci√≥n
            'view pnd', // Para alineaci√≥n
            'view programas', // Para alineaci√≥n
        ]);

        // üìä COORDINADOR DE PROGRAMAS
        // ‚úÖ CRUD COMPLETO: Programas
        // üëÄ SOLO LECTURA: Entidades, Planes (para vinculaci√≥n correcta)
        $coordinadorProgramasRole->givePermissionTo([
            'view dashboard',
            'manage programas',
            'view programas',
            'create programas',
            'edit programas',
            'delete programas',
            'view entidades', // Para vinculaci√≥n
            'view planes', // Para vinculaci√≥n
        ]);

        // üìà ANALISTA DE PROYECTOS
        // ‚úÖ CRUD COMPLETO: Proyectos
        // üëÄ SOLO LECTURA: Planes, Programas, Usuarios (para asignaciones)
        $analistaProyectosRole->givePermissionTo([
            'view dashboard',
            'manage proyectos',
            'view proyectos',
            'create proyectos',
            'edit proyectos',
            'delete proyectos',
            'view planes', // Para vinculaci√≥n
            'view programas', // Para vinculaci√≥n
            'view usuarios', // Para asignaciones
        ]);

        // üëÅÔ∏è SUPERVISOR GENERAL
        // ‚ùå NING√öN CRUD COMPLETO
        // üëÄ SOLO LECTURA: TODOS los CRUDs + Reportes
        $supervisorGeneralRole->givePermissionTo([
            'view dashboard',
            'view all_modules',
            // Solo lectura de todos los m√≥dulos
            'view usuarios',
            'view entidades',
            'view unidades',
            'view ods',
            'view objetivos_estrategicos',
            'view pnd',
            'view planes',
            'view programas',
            'view proyectos',
            // Acceso completo a reportes
            'view reports',
            'generate reports',
            'export reports',
        ]);

        // ==================================================================================
        // CREAR USUARIO ADMINISTRADOR POR DEFECTO
        // ==================================================================================
        
        $adminUser = User::where('email', 'admin@example.com')->first();
        $adminUser->assignRole($adminRole);

        // ==================================================================================
        // USUARIOS DE EJEMPLO PARA CADA ROL
        // ==================================================================================

        $users = [
            [
                'name' => 'Mar√≠a Gonz√°lez',
                'email' => 'maria.gonzalez@sipeip.gob.pe',
                'role' => $gestorEntidadesRole
            ],
            [
                'name' => 'Carlos Mendoza',
                'email' => 'carlos.mendoza@sipeip.gob.pe',
                'role' => $coordinadorUnidadesRole
            ],
            [
                'name' => 'Ana Rodr√≠guez',
                'email' => 'ana.rodriguez@sipeip.gob.pe',
                'role' => $especialistaOdsRole
            ],
            [
                'name' => 'Luis Fern√°ndez',
                'email' => 'luis.fernandez@sipeip.gob.pe',
                'role' => $planificadorEstrategicoRole
            ],
            [
                'name' => 'Elena Torres',
                'email' => 'elena.torres@sipeip.gob.pe',
                'role' => $analistaPndRole
            ],
            [
                'name' => 'Roberto Silva',
                'email' => 'roberto.silva@sipeip.gob.pe',
                'role' => $gestorPlanesRole
            ],
            [
                'name' => 'Carmen L√≥pez',
                'email' => 'carmen.lopez@sipeip.gob.pe',
                'role' => $coordinadorProgramasRole
            ],
            [
                'name' => 'Diego Herrera',
                'email' => 'diego.herrera@sipeip.gob.pe',
                'role' => $analistaProyectosRole
            ],
            [
                'name' => 'Patricia Vargas',
                'email' => 'patricia.vargas@sipeip.gob.pe',
                'role' => $supervisorGeneralRole
            ],
        ];

        foreach ($users as $userData) {
            $user = User::firstOrCreate([
                'email' => $userData['email']
            ], [
                'name' => $userData['name'],
                'password' => bcrypt('password123'),
                'email_verified_at' => now(),
            ]);

            $user->assignRole($userData['role']);
        }

        $this->command->info('‚úÖ Roles y permisos del Sistema SIPEIP 2.0 creados exitosamente');
        $this->command->info('üìã 10 roles espec√≠ficos con permisos granulares');
        $this->command->info('üë• 10 usuarios de ejemplo creados (admin + 9 especialistas)');
        $this->command->info('üîë Contrase√±a por defecto: password123 (admin: admin123)');
    }
}